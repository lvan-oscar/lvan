name: Fixed CUDA Test
on: [push]

jobs:
  cuda-test:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    container:
      image: registry.cn-hangzhou.aliyuncs.com/paddlepaddle/paddle:latest-cuda12.1.1
      options: --shm-size=1g --pull-timeout 600
      
    steps:
    # 步骤1：下载代码
    - name: Checkout code
      uses: actions/checkout@v4
      
    # 步骤2：验证路径（这是关键位置）
    - name: Verify directory
      run: |
        echo "Current path: $PWD"
        echo "Directory contents:"
        ls -la
      
    # 步骤3：安装依赖
    - name: Install dependencies
      run: |
        pip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple
        pip install torch==2.1.0 torchaudio librosa numpy
        
    # 步骤4：运行测试
    - name: Run tests
      run: |
        echo "===== CUDA device detection ====="
        python -c "import torch; print(f'CUDA available: {torch.cuda.is_available()}')"
        python -c "import torch; print(f'Device name: {torch.cuda.get_device_name(0)}')"
        
        echo "===== Running custom test ====="
        python gpu_test.py
